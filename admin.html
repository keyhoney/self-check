<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>자율학습 좌석 현황 (관리자)</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --primary-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      --secondary-gradient: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
      --accent-gradient: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
      --dark-bg: #0a0a0a;
      --card-bg: rgba(255, 255, 255, 0.05);
      --glass-bg: rgba(255, 255, 255, 0.1);
      --text-primary: #ffffff;
      --text-secondary: rgba(255, 255, 255, 0.7);
      --border-color: rgba(255, 255, 255, 0.1);
      --shadow-primary: 0 20px 40px rgba(0, 0, 0, 0.3);
      --shadow-hover: 0 30px 60px rgba(0, 0, 0, 0.4);
      --good: #16a34a;
      --bad: #ef4444;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Apple SD Gothic Neo, Noto Sans KR, Pretendard, Helvetica, Arial, sans-serif;
      background: var(--dark-bg);
      color: var(--text-primary);
      min-height: 100vh;
      overflow-x: hidden;
      position: relative;
    }

    /* Animated Background */
    body::before {
      content: '';
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: 
        radial-gradient(circle at 20% 80%, rgba(120, 119, 198, 0.3) 0%, transparent 50%),
        radial-gradient(circle at 80% 20%, rgba(255, 119, 198, 0.3) 0%, transparent 50%),
        radial-gradient(circle at 40% 40%, rgba(120, 219, 255, 0.2) 0%, transparent 50%);
      animation: backgroundShift 20s ease-in-out infinite;
      z-index: -1;
    }

    @keyframes backgroundShift {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.8; }
    }

    header {
      padding: 18px 20px;
      border-bottom: 1px solid var(--border-color);
      background: var(--glass-bg);
      backdrop-filter: blur(20px);
      position: sticky;
      top: 0;
      z-index: 3;
    }

    header h1 {
      margin: 0;
      font-size: 18px;
      font-weight: 600;
      background: var(--primary-gradient);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    main {
      max-width: 1100px;
      margin: 22px auto;
      padding: 0 16px;
      position: relative;
      z-index: 1;
    }

    .card {
      background: var(--glass-bg);
      backdrop-filter: blur(20px);
      border: 1px solid var(--border-color);
      border-radius: 24px;
      box-shadow: var(--shadow-primary);
      padding: 24px;
      transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .card:hover {
      transform: translateY(-4px);
      box-shadow: var(--shadow-hover);
      border-color: rgba(255, 255, 255, 0.2);
    }

    .row {
      display: flex;
      gap: 14px;
      flex-wrap: wrap;
    }

    label {
      display: block;
      font-size: 14px;
      color: var(--text-secondary);
      margin-bottom: 6px;
      font-weight: 500;
    }

    select, input, button {
      font-size: 16px;
      font-family: inherit;
    }

    select, input {
      width: 100%;
      padding: 12px 16px;
      border: 1px solid var(--border-color);
      border-radius: 12px;
      background: rgba(255, 255, 255, 0.05);
      color: var(--text-primary);
      backdrop-filter: blur(10px);
      transition: all 0.3s ease;
    }

    select:focus, input:focus {
      outline: none;
      border-color: rgba(79, 172, 254, 0.5);
      box-shadow: 0 0 0 3px rgba(79, 172, 254, 0.1);
    }

    select option {
      background: var(--dark-bg);
      color: var(--text-primary);
    }

    button.primary {
      background: var(--primary-gradient);
      border: none;
      color: #fff;
      padding: 12px 20px;
      border-radius: 12px;
      cursor: pointer;
      font-weight: 600;
      transition: all 0.3s ease;
      box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
    }

    button.primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(102, 126, 234, 0.4);
    }

    button.ghost {
      background: rgba(255, 255, 255, 0.05);
      border: 1px solid var(--border-color);
      color: var(--text-primary);
      padding: 8px 16px;
      border-radius: 10px;
      cursor: pointer;
      transition: all 0.3s ease;
      backdrop-filter: blur(10px);
    }

    button.ghost:hover {
      background: rgba(255, 255, 255, 0.1);
      border-color: rgba(255, 255, 255, 0.2);
      transform: translateY(-1px);
    }

    .muted {
      color: var(--text-secondary);
    }

    .success {
      color: var(--good);
    }

    .error {
      color: var(--bad);
    }

    /* 좌석표: 사진처럼 25칸 × 2줄 블럭이 두 개 */
    .grid {
      display: grid;
      grid-template-columns: repeat(25, 1fr);
      gap: 8px;
      min-width: 2200px; /* 25개 좌석 × 80px + 24개 간격 × 8px */
      padding-bottom: 8px;
    }

    .block-gap {
      height: 20px;
    }

    /* 좌석 그리드 컨테이너 */
    .grid-container {
      overflow-x: auto;
      padding-bottom: 8px;
      margin: 0 -16px;
      padding: 0 16px;
    }

    /* 스크롤바 스타일링 */
    .grid-container::-webkit-scrollbar {
      height: 8px;
    }

    .grid-container::-webkit-scrollbar-track {
      background: rgba(255, 255, 255, 0.1);
      border-radius: 4px;
    }

    .grid-container::-webkit-scrollbar-thumb {
      background: var(--primary-gradient);
      border-radius: 4px;
    }

    .grid-container::-webkit-scrollbar-thumb:hover {
      background: var(--secondary-gradient);
    }

    @media (max-width: 1100px) {
      .grid {
        grid-template-columns: repeat(10, 1fr);
      }
    }

    @media (max-width: 768px) {
      .grid {
        grid-template-columns: repeat(5, 1fr);
      }
    }

    .seat {
      border: 1px solid var(--border-color);
      background: var(--glass-bg);
      backdrop-filter: blur(10px);
      border-radius: 8px;
      min-height: 70px;
      min-width: 80px;
      padding: 8px;
      display: flex;
      flex-direction: column;
      justify-content: space-between;
      transition: all 0.3s ease;
      cursor: pointer;
      font-size: 13px;
    }

    .seat:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 20px rgba(0, 0, 0, 0.2);
      border-color: rgba(255, 255, 255, 0.2);
    }

    .seatHeader {
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 12px;
      color: var(--text-primary);
      font-weight: 600;
      margin-bottom: 4px;
    }

    .seat .name {
      font-size: 12px;
      font-weight: 500;
      line-height: 1.2;
      text-align: center;
    }

    .seat .class-info {
      font-size: 11px;
      color: var(--text-secondary);
      text-align: center;
      margin-top: 2px;
    }

    .seat.free {
      opacity: 0.6;
    }

    .seat.occupied {
      background: rgba(34, 197, 94, 0.15); /* 옅은 투명 초록색 배경 */
      border-color: rgba(34, 197, 94, 0.3);
    }

    .seat.occupied:hover {
      background: rgba(34, 197, 94, 0.25);
      border-color: rgba(34, 197, 94, 0.5);
    }

    .legend {
      display: flex;
      gap: 12px;
      align-items: center;
      font-size: 14px;
      color: var(--text-secondary);
    }

    .pill {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      border: 1px solid var(--border-color);
      border-radius: 999px;
      padding: 6px 12px;
      background: var(--glass-bg);
      backdrop-filter: blur(10px);
    }

    /* Loading Animation */
    @keyframes fadeInUp {
      from {
        opacity: 0;
        transform: translateY(30px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .card {
      animation: fadeInUp 0.6s ease forwards;
    }

    /* Scrollbar Styling */
    ::-webkit-scrollbar {
      width: 8px;
    }

    ::-webkit-scrollbar-track {
      background: rgba(255, 255, 255, 0.1);
    }

    ::-webkit-scrollbar-thumb {
      background: var(--primary-gradient);
      border-radius: 4px;
    }

    ::-webkit-scrollbar-thumb:hover {
      background: var(--secondary-gradient);
    }

    /* Responsive Design */
    @media (max-width: 768px) {
      main {
        padding: 0 12px;
      }
      
      .card {
        padding: 18px;
      }
      
      header {
        padding: 16px 20px;
      }
    }
  </style>
  <!-- 외부 라이브러리: Firebase -->
  <script type="module">
    // ======= 1) Firebase 설정 =======
    // ⚠️ 아래 설정을 본인의 프로젝트로 바꾸세요 (Firebase 콘솔 > 프로젝트 설정 > SDK 설정 및 구성)
    // ⚠️ Firestore 보안 규칙을 다음과 같이 설정하세요 (Firebase 콘솔 > Firestore Database > 규칙):
    // rules_version = '2';
    // service cloud.firestore {
    //   match /databases/{database}/documents {
    //     match /checkins/{document} {
    //       allow read, write: if true;
    //     }
    //   }
    // }
    const firebaseConfig = {
      apiKey: "AIzaSyBSfmmAYJAi3vXg3ZclB0PiBaNyV2lJ24s",
      authDomain: "self-check-3d44e.firebaseapp.com",
      projectId: "self-check-3d44e",
      storageBucket: "self-check-3d44e.firebasestorage.app",
      messagingSenderId: "1013380899103",
      appId: "1:1013380899103:web:3f3125f116446835c3d02a"
    };

    const $ = (sel,root=document)=>root.querySelector(sel);
    const $$ = (sel,root=document)=>Array.from(root.querySelectorAll(sel));
    const params = new URLSearchParams(location.search);
    const dateParam = params.get('date');

    const todayKey = () => {
      const d = new Date();
      const y = d.getFullYear();
      const m = String(d.getMonth()+1).padStart(2,'0');
      const dd = String(d.getDate()).padStart(2,'0');
      return `${y}-${m}-${dd}`;
    }
    const fmtClassNo = (klass, num) => `${klass}반 ${num}번`;

    // JSON 파일에서 명단 로드
    async function loadRosterFromJSON() {
      try {
        const response = await fetch('name_list.json');
        const jsonData = await response.json();
        
        const roster = {};
        jsonData.forEach(student => {
          const klass = student.반;
          const number = student.번호;
          const name = student.이름;
          
          if (klass >= 1 && klass <= 10 && number >= 1 && number <= 25) {
            if (!roster[klass]) roster[klass] = {};
            roster[klass][number] = name;
          }
        });
        
        return roster;
      } catch (error) {
        console.error('JSON 파일 로드 실패:', error);
        return {};
      }
    }

    import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js';
    import { getFirestore, collection, doc, setDoc, getDoc, getDocs, updateDoc, deleteDoc, onSnapshot, query, where } from 'https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore.js';

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    // Firestore 스키마
    // collection: 'checkins' -> document: '{date}_{seat}' -> { class: number, number: number, name: string, ts: number }
    // 명단은 name_list.json 파일에서 로드

    // ===== 렌더 =====
    const header = document.createElement('header');
    header.innerHTML = `<h1>자율학습 좌석 현황 (관리자)</h1>`;
    document.body.appendChild(header);
    const main = document.createElement('main');
    document.body.appendChild(main);

    // 비밀번호 확인
    const pass = prompt('관리자 비밀번호를 입력하세요');
    if(pass !== 'honey'){
      const c = document.createElement('div');
      c.className='card'; 
      c.innerHTML = '<p class="error">비밀번호가 올바르지 않습니다.</p>';
      main.appendChild(c); 
    } else {
      renderAdmin();
    }

    // ===== 관리자(좌석판) =====
    async function renderAdmin(){
      const container = document.createElement('div'); 
      container.className='card';
      const dateKey = dateParam || todayKey();
      container.innerHTML = `
        <div style="display:flex;gap:10px;align-items:center;justify-content:space-between;margin-bottom:10px">
          <div>
            <div style="display:flex;align-items:center;gap:12px;margin-bottom:6px">
              <strong>${dateKey}</strong> 좌석 현황
              <div id="attendanceCounter" class="pill" style="background:rgba(34, 197, 94, 0.2);border-color:rgba(34, 197, 94, 0.4);color:var(--good);font-weight:600">
                출석: <span id="attendanceCount">0</span>명
              </div>
            </div>
            <div class="legend">
              <span class="pill"><span style="width:10px;height:10px;border-radius:50%;background:rgba(34, 197, 94, 0.8);display:inline-block"></span> 체크됨</span>
              <span class="pill"><span style="width:10px;height:10px;border-radius:50%;background:var(--line);display:inline-block"></span> 비어있음</span>
            </div>
          </div>
          <div style="display:flex;gap:8px;align-items:center">
            <input id="dateInput" type="date" />
            <button class="ghost" id="reload">새로고침</button>
          </div>
        </div>
        <div class="grid-container">
          <div id="grid" class="grid"></div>
          <div class="block-gap"></div>
          <div id="grid2" class="grid"></div>
        </div>
        <p class="muted" style="margin-top:10px">좌석을 클릭하면 비우거나(삭제) 상세 정보를 볼 수 있습니다. 가로 스크롤을 사용하세요.</p>
      `;
      main.appendChild(container);

      const dateInput = $('#dateInput', container); 
      dateInput.value = dateKey;
      const grid = $('#grid', container); 
      const grid2 = $('#grid2', container);
      
      for(let i=1;i<=50;i++) grid.appendChild(makeSeat(i));
      for(let i=51;i<=100;i++) grid2.appendChild(makeSeat(i));
      
      function makeSeat(i){ 
        const d=document.createElement('div'); 
        d.className='seat free'; 
        d.dataset.seat=String(i); 
        d.innerHTML=`
          <div class="seatHeader">#${i}</div>
          <div class="name muted">-</div>
          <div class="class-info muted">-</div>
        `; 
        return d; 
      }

      let roster = {};
      loadRosterFromJSON().then(loadedRoster => {
        roster = loadedRoster;
      });
      
      // Firestore 구조: checkins/날짜_좌석번호
      onSnapshot(collection(db, 'checkins'), (snapshot) => {
        const checkins = {};
        snapshot.forEach((doc) => {
          const [date, seat] = doc.id.split('_');
          if (date === dateKey) {
            checkins[seat] = doc.data();
          }
        });
        draw(checkins);
      });

      function draw(checkins){
        let attendanceCount = 0; // 출석한 학생 수 카운터
        
        [...$$('.seat',grid), ...$$('.seat',grid2)].forEach(cell=>{
          const seat=cell.dataset.seat; 
          const item=checkins[seat];
          
          if(item){ 
            attendanceCount++; // 출석한 학생 수 증가
            const nm=item.name || roster?.[item.class]?.[item.number] || ''; 
            cell.classList.remove('free'); 
            cell.classList.add('occupied'); // 학생이 있는 자리 표시
            
            // 좌석 번호는 그대로 유지
            cell.querySelector('.seatHeader').textContent=`#${seat}`;
            
            // 이름 표시
            cell.querySelector('.name').textContent=nm||'(이름없음)'; 
            cell.querySelector('.name').classList.remove('muted');
            
            // 반, 번호 정보 표시
            cell.querySelector('.class-info').textContent=`${item.class}반 ${item.number}번`; 
            cell.querySelector('.class-info').classList.remove('muted');
          }
          else{ 
            cell.classList.add('free'); 
            cell.classList.remove('occupied'); // 비어있는 자리 표시
            
            // 좌석 번호는 그대로 유지
            cell.querySelector('.seatHeader').textContent=`#${seat}`;
            
            // 비어있을 때는 이름과 반 정보를 숨김
            cell.querySelector('.name').textContent=''; 
            cell.querySelector('.name').classList.add('muted');
            
            cell.querySelector('.class-info').textContent=''; 
            cell.querySelector('.class-info').classList.add('muted');
          }
        });
        
        // 출석 카운터 업데이트
        const counterElement = $('#attendanceCount', container);
        if (counterElement) {
          counterElement.textContent = attendanceCount;
        }
      }

      grid.addEventListener('click', seatClick); 
      grid2.addEventListener('click', seatClick);
      
      async function seatClick(e){ 
        const cell=e.target.closest('.seat'); 
        if(!cell) return; 
        const seat=cell.dataset.seat; 
        const docId = `${dateKey}_${seat}`;
        
        try {
          const docSnap = await getDoc(doc(db, 'checkins', docId));
          if(!docSnap.exists()) return alert(`#${seat} 빈 좌석입니다.`); 
          
          const v = docSnap.data(); 
          const nm = v.name || roster?.[v.class]?.[v.number] || ''; 
          const ok = confirm(`#${seat} ${fmtClassNo(v.class,v.number)} ${nm}\n이 좌석을 비우시겠습니까?`); 
          
          if(ok){ 
            await deleteDoc(doc(db, 'checkins', docId)); 
          }
        } catch (error) {
          console.error('좌석 삭제 실패:', error);
          alert('좌석 삭제 중 오류가 발생했습니다.');
        }
      }

      $('#reload',container).addEventListener('click', ()=>{ 
        const base=location.href.split('?')[0]; 
        location.href=`${base}?date=${dateInput.value}`; 
      });
      
    }
  </script>
</head>
<body></body>
</html>
